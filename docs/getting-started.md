# Getting Started

In order to use this, you will need two things configured:

1. An Azure Service connection that the pipeline can use for Azure CLI task (aka "service principal")
2. An Akeyless "Auth Method" that points to #1, and Access Role that allows reading secrets

Let me take you through setting each up.

> [!NOTE]
> You may have some of these items alreadt. For example, #1 is a very common thing to already have available to your pipeline. Feel free to skip any "create a new" steps, but just make sure the configuration of the existing item matches the requirements.

## Azure Setup

You need to be able to prove the identiy of the pipeline requesting access to Akeyless. This can be done using 

You probbaly already have an Azure Service principal configured for the pipeline, but if you don't you can add one to the Service connections

1. In your Azure DevOps project, click Settings (bottom left on most screens)
2. In the left menu, find and select "Service Connections"
3. Click "New Service Connection"
4. Select "Azure Resource Manager"
5. Select "Service principal (automatic)" (or "Workload Identity federation (automatic)" for modern set ups, it does the same thing as a service principal)
6. Complete the form with your Azure subscription selections
   1. There's a checkbox to allow the service connection to be accessible by all of that project's pipelines. this is up to your needs, but you can select the principal later on when setting up the Azure CLI task.

When it is complete, select the item to see the details view. Here you will see a link that will bring you over to the Azure portal.

![service connection details](https://github.com/LanceMcCarthy/akeyless-extension-azdo/assets/3520532/c5a805a5-8b0f-4f26-8dfa-c65b70c214d0)

Then when in the portal, you will see the details. Take note the `appId` and `tenantId` as you will use them when configuring Akeyless in the enxt section

![azure portal 1](https://github.com/LanceMcCarthy/akeyless-extension-azdo/assets/3520532/cb01fa63-4d0e-49d3-8bf2-3597692e3be2)

## AKeyless Setup

This action supports authenticating with AKeyless using JWT generated by an Azure service principal (via the pipeline's Service connections setting).

To configure AKeyless and grant your repositories the necessary permissions:

1. Create a new JWT Auth method in AKeyless
    1. In AKeyless, select "Users & Auth Methods" from the left nav menu
    2. Click "+ New"
    3. In the **Select Type** tab
       1. Select "OAuth 2.0/JWT" from the "Application" group.
       2. Click Next
    4. In the **Basic Configuration** tab
       1. Specify a name (e.g. "Token for Azure DevOps") and location (e.g. "/personal-methods/lance/") of your choice.
       2. Scroll down and click "Require Sub Claim on role association". This will prevent you from attaching this to a role without any additional checks **that make this a critical checkbox!!!**
       3. Click Next
    5. In the **OAuth 2.0/JWT Configuration** tab
       1. For the JWKS Url, use `https://login.microsoftonline.com/common/discovery/keys`
       2. For the unique identifier, you can use the Azure service principal's `tenantId` or `appId`. This is for billing purposes, see note (1) below for more details.
    6. When completed, it should look like this and take note of the `Access Id` (you will use this id later in your Azure Pipeline).
       - ![completed auth method](https://github.com/LanceMcCarthy/akeyless-extension-azdo/assets/3520532/054d31f8-752f-4436-a707-5bbb2100a04a)
       - ![completed auth method 2](https://github.com/LanceMcCarthy/akeyless-extension-azdo/assets/3520532/4af89648-260d-41a5-85f0-d450dba22f84)
2. Setup the Access Role (you can use an existing one, or create a new one)
    1. In AKeyless go to "Access Roles" -> "+ New"
    2. Give it a name and location, and create it.
    3. Find your new access role and click on it to edit it.
    4. On the right side, under "Secrets & Keys", click the "Add" button to configure read access to any static or dynamic secrets you will fetch from your pipeline.
3. Attach the Auth method created in #1 to the Access Role from #2.
    1. Once again, find the access role you created in step #2 above and click on it to edit it.
    2. Hit the **+ Associate** button
    3. In the dropdown list, find the auth method you created in Step #1 above and select it (we named it "Azure JWT Auth")
    4. IMPORTANT: Add an appropriate subclaim
       - I recommend using the service principal's `appid` (case sensitive!)to restrict access to only that this. **See note (2) below for more details and a subclaims list.**
    5. Save!

After following these steps, you'll be ready to use JWT Auth from your Azure DevOps. Go to the [Examples documentation] to see a starter pipeline.

### Notes

> [!WARNING]
> Please pay attention to the case sensitive nature of items, most things in Akeyless are case sensitive, including paths and key names.

> [!NOTE]
>  **(1)** The unique identifier is mainly used for auditing/billing purposes, so there isn't one correct answer here.  `tenantId` or even `appId` is a sensible default. If you are uncertain, talk to AKeyless for more details.

> [!NOTE]
> **(2)** Subclaim checks allow AKeyless to grant access to specific workflows, based on the claims that are provided in the JWT. We **strongly** recommend restricting the access by using the service principal's `appid` for the required subclaim. For Azure Service Principal, here is a small portion of the subclaims map that akeyless can use:

```
[
  appid:[your-service-principal-app-id] 
  aud:[https://management.core.windows.net/]
  idp:[https://sts.windows.net/your-tenant-id/]
  iss:[https://sts.windows.net/your-tenant-id/]>
  sub:[your-subscription-id] 
  tid:[your-tenant-id] 
  ...
]
```
Using the `appid` allows you to make sure only that exact service principal can access the secrets. While using a tenantId allos any service principal in the org to access them. Choose appropriately for your needs. 